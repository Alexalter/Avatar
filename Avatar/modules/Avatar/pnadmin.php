<?php
/**
 * Avatar Module
 *
 * The Avatar module allows uploading of individual Avatars.
 * It is based on EnvoAvatar from A.T.Web, http://www.atw.it
 *
 * @package      Avatar
 * @version      $Id$
 * @author       Joerg Napp
 * @link         http://lottasophie.sf.net
 * @copyright    Copyright (C) 2004
 * @license      http://www.gnu.org/copyleft/gpl.html GNU General Public License
 */


/**
 * the main administration function
 *
 * This function is the default function, and is called whenever the
 * module is called without defining arguments.
 * As such it can be used for a number of things, but most commonly
 * it either just shows the module menu and returns or calls whatever
 * the module designer feels should be the default function (often this
 * is the view() function)
 *
 * @author       The PostNuke Development Team
 * @return       output       The main module admin page.
 */
function Avatar_admin_main()
{
    if (!(pnSecAuthAction(0, 'Avatar::', '::', ACCESS_ADMIN))) {
        return _NOAUTH;
    }

    // get all groups
    list($dbconn) = pnDBGetConn();
    $pntable = pnDBGetTables();
    $groups_column = &$pntable['groups_column'];
    $sql = "SELECT * FROM $pntable[groups] ORDER BY $groups_column[gid], $groups_column[name]";

    $articleresult = $dbconn->Execute($sql);
    $groups = array()    ;
    while (!$articleresult->EOF) {
        $crow = $articleresult->GetRowAssoc(false);
        $groups[$crow[pn_gid]] = $crow[pn_name];
        $articleresult->MoveNext();
    }
    $groups[0] = _AVATAR_ADM_GROUPS_ALL;
    ksort($groups);


    $pnRender =& new pnRender('Avatar');

    // We need the pnsecgenauthkey plugin, so we must not cache here.
    $pnRender->caching = false;

    $pnRender->assign('groups',             $groups);
    $pnRender->assign('avatardir',          pnModGetVar('Avatar', 'avatardir'));
    $pnRender->assign('forumdir',           pnModGetVar('Avatar', 'forumdir'));
    $pnRender->assign('allow_resize',       pnModGetVar('Avatar', 'allow_resize'));
    $pnRender->assign('maxsize',            pnModGetVar('Avatar', 'maxsize'));
    $pnRender->assign('maxheight',          pnModGetVar('Avatar', 'maxheight'));
    $pnRender->assign('maxwidth',           pnModGetVar('Avatar', 'maxwidth'));
    $pnRender->assign('allowed_extensions', pnModGetVar('Avatar', 'allowed_extensions'));
    $pnRender->assign('prefix_group_1',     pnModGetVar('Avatar', 'prefix_group_1'));
    $pnRender->assign('prefix_group_2',     pnModGetVar('Avatar', 'prefix_group_2'));
    $pnRender->assign('prefix_group_3',     pnModGetVar('Avatar', 'prefix_group_3'));
    $pnRender->assign('prefix_prefix_1',    pnModGetVar('Avatar', 'prefix_prefix_1'));
    $pnRender->assign('prefix_prefix_2',    pnModGetVar('Avatar', 'prefix_prefix_2'));
    $pnRender->assign('prefix_prefix_3',    pnModGetVar('Avatar', 'prefix_prefix_3'));

    $pnRender->assign('warn_pntemp',        !is_writable(pnConfigGetVar('temp')));
    $pnRender->assign('warn_avatardir',     !is_writable(pnModGetVar('Avatar', 'avatardir')));
    $pnRender->assign('warn_forumdir',      !is_writable(pnModGetVar('Avatar', 'forumdir')));

    // Return the output that has been generated by this function
    return $pnRender->fetch('Avatar_admin_main.htm');
}

/**
 * Avatar_admin_save()
 *
 * Save the settings made.
 *
 * @return
 **/
function Avatar_admin_save()
{
    if (!(pnSecAuthAction(0, 'Avatar::', '::', ACCESS_ADMIN))) {
        return _NOAUTH;
    }
    if (!pnSecConfirmAuthKey()) {
        return  _BADAUTHKEY;
    }

    list($avatardir,
         $forumdir,
         $maxsize,
         $maxheight,
         $maxwidth,
         $allowed_extensions,
         $allow_resize,
         $prefix_group_1,
         $prefix_group_2,
         $prefix_group_3,
         $prefix_prefix_1,
         $prefix_prefix_2,
         $prefix_prefix_3) = pnVarCleanFromInput('avatardir',
                                                 'forumdir',
                                                 'maxsize',
                                                 'maxheight',
                                                 'maxwidth',
                                                 'allowed_extensions',
                                                 'allow_resize',
                                                 'prefix_group_1',
                                                 'prefix_group_2',
                                                 'prefix_group_3',
                                                 'prefix_prefix_1',
                                                 'prefix_prefix_2',
                                                 'prefix_prefix_3');

    $extensions = explode(';', $allowed_extensions);
    foreach ($extensions as $key=>$extension) {
        $extensions[$key] = str_replace('.', '', trim($extension));
    }
    $allowed_extensions = implode(';', $extensions);

    pnModSetVar('Avatar', 'avatardir',          $avatardir);
    pnModSetVar('Avatar', 'forumdir',           $forumdir);
    pnModSetVar('Avatar', 'allow_resize',       ($allow_resize == 'allow_resize'));
    pnModSetVar('Avatar', 'maxsize',            (int)$maxsize);
    pnModSetVar('Avatar', 'maxheight',          (int)$maxheight);
    pnModSetVar('Avatar', 'maxwidth',           (int)$maxwidth);
    pnModSetVar('Avatar', 'allowed_extensions', $allowed_extensions);
    pnModSetVar('Avatar', 'prefix_group_1',     $prefix_group_1);
    pnModSetVar('Avatar', 'prefix_group_2',     $prefix_group_2);
    pnModSetVar('Avatar', 'prefix_group_3',     $prefix_group_3);
    pnModSetVar('Avatar', 'prefix_prefix_1',    $prefix_prefix_1);
    pnModSetVar('Avatar', 'prefix_prefix_2',    $prefix_prefix_2);
    pnModSetVar('Avatar', 'prefix_prefix_3',    $prefix_prefix_3);

    pnRedirect(pnModURL('Avatar', 'admin', 'main'));
}
?>